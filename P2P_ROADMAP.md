# AI Perp DEX v2 - P2P Agent Trading

> ä»ä¼ ç»Ÿè®¢å•ç°¿ â†’ Agent-to-Agent ç›´æ¥å¯¹æ‰‹äº¤æ˜“

## ğŸ¯ æ ¸å¿ƒç†å¿µ

**Agent æœ¬èº«å°±æ˜¯æµåŠ¨æ€§**
- ä¸éœ€è¦ Vault æˆ– AMM
- Agent äº’ä¸ºäº¤æ˜“å¯¹æ‰‹æ–¹
- 24/7 è‡ªåŠ¨æŠ¥ä»·ã€æ¥å•
- çœŸæ­£çš„ AI Native

---

## ğŸ“ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI Perp DEX v2                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Agent A    â”‚    â”‚  Agent B    â”‚    â”‚  Agent C    â”‚  â”‚
â”‚  â”‚  (Trader)   â”‚    â”‚  (MM)       â”‚    â”‚  (MM)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                  â”‚                  â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                      â–¼                                   â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚    Trade Router        â”‚ â† WebSocket å¹¿æ’­      â”‚
â”‚         â”‚    (Rust Server)       â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                     â–¼                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚   Solana Escrow        â”‚ â† ä¿è¯é‡‘é”å®š          â”‚
â”‚         â”‚   Program              â”‚ â† è‡ªåŠ¨ç»“ç®—            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ äº¤æ˜“æµç¨‹

### Phase 1: å‘èµ·äº¤æ˜“è¯·æ±‚
```
Agent A â†’ POST /trade/request
{
    "agent_id": "AgentA_pubkey",
    "market": "BTC-PERP",
    "side": "long",
    "size_usdc": 100,
    "leverage": 10,
    "max_funding_rate": 0.01,  // æ„¿æ„ä»˜çš„æœ€é«˜è´¹ç‡
    "duration": "perpetual",    // æˆ– "1h", "24h" å®šæœŸ
    "expires_in": 30            // 30ç§’å†…ç­‰å¾…æŠ¥ä»·
}
```

### Phase 2: åšå¸‚ Agent å“åº”
```
Trade Router é€šè¿‡ WebSocket å¹¿æ’­è¯·æ±‚
â†“
MM Agent B æ”¶åˆ°ï¼Œå†³å®šæ¥å•
â†“
Agent B â†’ POST /trade/quote
{
    "request_id": "xxx",
    "agent_id": "AgentB_pubkey", 
    "funding_rate": 0.005,      // æˆ‘è¦æ”¶çš„è´¹ç‡
    "collateral_usdc": 100,     // æˆ‘æ„¿æ„æŠ¼çš„ä¿è¯é‡‘
    "valid_for": 10             // æŠ¥ä»·æœ‰æ•ˆ10ç§’
}
```

### Phase 3: æ’®åˆæˆäº¤
```
Agent A æ”¶åˆ°å¤šä¸ªæŠ¥ä»·
â†“
é€‰æ‹©æœ€ä¼˜ (æœ€ä½ funding rate)
â†“
POST /trade/accept
{
    "request_id": "xxx",
    "quote_id": "yyy",
    "signature": "..."
}
â†“
Trade Router é€šçŸ¥åŒæ–¹
â†“
åŒæ–¹ç­¾å â†’ æäº¤åˆ° Solana Escrow
```

### Phase 4: é“¾ä¸Šé”å®š
```rust
// Solana Escrow Program
pub fn lock_position(
    agent_a: Pubkey,      // äº¤æ˜“æ–¹
    agent_b: Pubkey,      // å¯¹æ‰‹æ–¹
    market: u8,           // BTC=0, ETH=1, SOL=2
    size: u64,            // ä»“ä½å¤§å°
    entry_price: u64,     // å…¥åœºä»·æ ¼
    leverage: u8,         // æ æ†
    collateral_a: u64,    // A çš„ä¿è¯é‡‘
    collateral_b: u64,    // B çš„ä¿è¯é‡‘
) -> Result<Position>
```

### Phase 5: æŒä»“æœŸé—´
```
æ¯ 8 å°æ—¶:
  - è·å– Oracle ä»·æ ¼ (Pyth)
  - è®¡ç®— PnL
  - ç»“ç®—èµ„é‡‘è´¹ç‡ (å¤šå¤´ä»˜ç©ºå¤´ æˆ– åè¿‡æ¥)
  - æ£€æŸ¥ä¿è¯é‡‘ç‡ï¼Œä¸è¶³åˆ™æ¸…ç®—
```

### Phase 6: å¹³ä»“
```
Agent A â†’ POST /trade/close
{
    "position_id": "xxx",
    "size_percent": 100  // å¹³ä»“æ¯”ä¾‹
}
â†“
é€šçŸ¥å¯¹æ‰‹æ–¹ Agent B
â†“
è·å–å½“å‰ä»·æ ¼
â†“
é“¾ä¸Šç»“ç®—:
  - è®¡ç®—æœ€ç»ˆ PnL
  - èµ¢å®¶æ‹¿èµ°åˆ©æ¶¦
  - é‡Šæ”¾ä¿è¯é‡‘
```

---

## ğŸ“ ä»£ç ç»“æ„

```
ai-perp-dex/
â”œâ”€â”€ trade-router/           # æ–°å»º - äº¤æ˜“è·¯ç”±æœåŠ¡
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ main.rs
â”‚       â”œâ”€â”€ router.rs       # è¯·æ±‚è·¯ç”±
â”‚       â”œâ”€â”€ quotes.rs       # æŠ¥ä»·ç®¡ç†
â”‚       â”œâ”€â”€ matching.rs     # æ’®åˆé€»è¾‘
â”‚       â”œâ”€â”€ websocket.rs    # WS å¹¿æ’­
â”‚       â””â”€â”€ types.rs
â”‚
â”œâ”€â”€ escrow-program/         # æ–°å»º - Solana æ‰˜ç®¡åˆçº¦
â”‚   â””â”€â”€ programs/escrow/
â”‚       â””â”€â”€ src/
â”‚           â”œâ”€â”€ lib.rs
â”‚           â”œâ”€â”€ state.rs    # Position, Agent çŠ¶æ€
â”‚           â”œâ”€â”€ lock.rs     # é”å®šä¿è¯é‡‘
â”‚           â”œâ”€â”€ settle.rs   # ç»“ç®— PnL
â”‚           â”œâ”€â”€ close.rs    # å¹³ä»“
â”‚           â””â”€â”€ liquidate.rs # æ¸…ç®—
â”‚
â”œâ”€â”€ agent-sdk/
â”‚   â””â”€â”€ python/
â”‚       â””â”€â”€ ai_perp_dex/
â”‚           â”œâ”€â”€ trader.py   # äº¤æ˜“è€… Agent
â”‚           â”œâ”€â”€ market_maker.py  # åšå¸‚ Agent
â”‚           â””â”€â”€ p2p.py      # P2P åè®®
â”‚
â”œâ”€â”€ mm-agents/              # æ–°å»º - æˆ‘ä»¬çš„åšå¸‚ Agent
â”‚   â”œâ”€â”€ conservative_mm.py  # ä¿å®ˆå‹ MM
â”‚   â”œâ”€â”€ aggressive_mm.py    # æ¿€è¿›å‹ MM
â”‚   â””â”€â”€ arbitrage_mm.py     # å¥—åˆ©å‹ MM
â”‚
â””â”€â”€ oracle/                 # Oracle é›†æˆ
    â””â”€â”€ pyth_feed.py
```

---

## ğŸš€ å®ç°è®¡åˆ’

### Step 1: Trade Router (2-3h) âœ…
- [x] WebSocket æœåŠ¡å™¨
- [x] äº¤æ˜“è¯·æ±‚å¹¿æ’­
- [x] æŠ¥ä»·æ”¶é›†
- [x] æ’®åˆé€»è¾‘

### Step 2: Escrow Program (3-4h) âœ…
- [x] Position çŠ¶æ€ç»“æ„
- [x] lock_position æŒ‡ä»¤
- [x] settle_funding æŒ‡ä»¤
- [x] close_position æŒ‡ä»¤
- [x] liquidate æŒ‡ä»¤

### Step 3: Agent SDK (2h) âœ…
- [x] P2P äº¤æ˜“åè®®
- [x] Trader Agent ç±»
- [x] Market Maker Agent åŸºç±»

### Step 4: MM Agents (2h) âœ…
- [x] åŸºç¡€åšå¸‚ Agent (conservative_mm.py)
- [x] è‡ªåŠ¨æŠ¥ä»·é€»è¾‘ (aggressive_mm.py)
- [x] é£é™©ç®¡ç† (arbitrage_mm.py)

### Step 5: é›†æˆæµ‹è¯• (2h)
- [ ] ç«¯åˆ°ç«¯äº¤æ˜“æµ‹è¯•
- [ ] å¤š Agent å¹¶å‘æµ‹è¯•
- [ ] æ¸…ç®—åœºæ™¯æµ‹è¯•

---

## ğŸ® API è®¾è®¡

### REST Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | /trade/request | å‘èµ·äº¤æ˜“è¯·æ±‚ |
| POST | /trade/quote | æäº¤æŠ¥ä»· |
| POST | /trade/accept | æ¥å—æŠ¥ä»· |
| POST | /trade/close | å¹³ä»“ |
| GET | /positions | æŸ¥çœ‹æŒä»“ |
| GET | /quotes | æŸ¥çœ‹æ´»è·ƒæŠ¥ä»· |
| GET | /markets | å¸‚åœºä¿¡æ¯ |

### WebSocket Events

| Event | Direction | Description |
|-------|-----------|-------------|
| trade_request | Serverâ†’Client | æ–°äº¤æ˜“è¯·æ±‚ |
| quote | Clientâ†’Server | æäº¤æŠ¥ä»· |
| quote_accepted | Serverâ†’Client | æŠ¥ä»·è¢«æ¥å— |
| position_opened | Serverâ†’Client | ä»“ä½å¼€å¯ |
| position_closed | Serverâ†’Client | ä»“ä½å…³é—­ |
| liquidation | Serverâ†’Client | æ¸…ç®—é€šçŸ¥ |

---

## ğŸ’° ç»æµæ¨¡å‹

### è´¹ç”¨ç»“æ„
- å¼€ä»“è´¹: 0.05% (ç»™åè®®)
- èµ„é‡‘è´¹ç‡: ç”±å¸‚åœºå†³å®š (å¤šç©ºæ”¯ä»˜)
- æ¸…ç®—å¥–åŠ±: æ¸…ç®—é‡‘é¢çš„ 5%

### åšå¸‚æ¿€åŠ±
- MM Agent èµšå– bid-ask spread
- æä¾›æ›´å¥½æŠ¥ä»· â†’ æ›´å¤šæˆäº¤ â†’ æ›´å¤šæ”¶ç›Š

---

## ğŸ›¡ï¸ é£é™©ç®¡ç†

### ä¿è¯é‡‘è¦æ±‚
- åˆå§‹ä¿è¯é‡‘: ä»“ä½ / æ æ†
- ç»´æŒä¿è¯é‡‘: åˆå§‹ä¿è¯é‡‘çš„ 50%
- ä½äºç»´æŒ â†’ è§¦å‘æ¸…ç®—

### æ¸…ç®—æœºåˆ¶
```
ä¿è¯é‡‘ç‡ = å‰©ä½™ä¿è¯é‡‘ / ä»“ä½ä»·å€¼
ä¿è¯é‡‘ç‡ < 5% â†’ ä»»ä½•äººå¯ä»¥æ¸…ç®—
æ¸…ç®—è€…è·å¾— 5% å¥–åŠ±
```

---

## ğŸ“… Timeline

| æ—¶é—´ | é‡Œç¨‹ç¢‘ |
|------|--------|
| Day 1 | Trade Router + åŸºç¡€ API |
| Day 2 | Escrow åˆçº¦ + é“¾ä¸Šé›†æˆ |
| Day 3 | SDK + MM Agents |
| Day 4 | æµ‹è¯• + ä¿®å¤ |
| Day 5 | Devnet ä¸Šçº¿ |

---

**å¼€å§‹å¹²æ´»ï¼** ğŸ”¨
